---
title: "Main_Part02_20240416_AnalyzeOKU"
author: "Yusuke Naoi"
date: "2024-04-16"
output: html_document
---

#Descripton
- In this file, we define final study cohort for downstream analysis.
- Samples with low tumor content (less than 20%) or pathologically inappropriate (extremely low content of tumor cells, small specimens, widespread tissue damage, overstaining, and negative without internal positive controls) are exclude.

#Set Working Directory To Project Directory
```{r}
#cwd <- "path_to_project_directory"
setwd(cwd)
getwd()

set.seed(2024)
```

#color palette
```{r message=FALSE, warning=FALSE}
color_HighLow <- c("#e41a1c","#0072b5")
color_coo <- c("#078282", #DZsig-pos
               "#339e66", #GCB
               "#95DBe5" #ABC
               )
color_hans <- c("#339e66", #GCB
                "#95DBe5" #NonGC
                ) 
color_PosNeg <- c("#19a53a", #POS
                  "#00299b" #NEG
                  )
```

#Load function (define_cohort_OKU.R)
```{r message=FALSE, warning=FALSE}
.myfunc.env = new.env()
sys.source( "./func/Func02_define_cohort_OKU.R", envir = .myfunc.env )
attach( .myfunc.env )

define_cohort()
```

# histogram/density plot (DLBCL90_COO)
```{r fig.height=4, fig.width=4, message=FALSE, warning=FALSE}
library(ggplot2);library(dplyr)

df <- read.csv("./saved/Scores/OKU_defined_cohort_withoutUNC.csv")
df$DLBCL90 <- factor(df$DLBCL90, levels = c("DZsig-pos","GCB","ABC"))
res <- summary(df$OKU_CD79b_Hscore)
df$OKU_CD79b_Hscore_class <- factor(df$OKU_CD79b_Hscore_class, levels = c("Low","High"))

# density plot
g <- ggplot(df, aes(x = OKU_CD79b_Hscore, fill=DLBCL90)) + 
  geom_density(alpha=0.65)+
  geom_vline(aes(xintercept=res[[3]]))+
  theme_classic()+
  xlab("H-score")+
  ylab("count") +
  labs(caption = paste0("n=",nrow(df))) +
  theme(
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.text.x.bottom = element_text(size = 6, face = "bold"),
    axis.title.y = element_text(size = 7, face = "bold"),
    axis.text.y = element_text(size = 6, face = "bold"),
    legend.text = element_text(size = 6, face = "bold"),
    legend.title = element_text(size = 6, face = "bold"),
    legend.position = c(.4,.95),
    legend.key.width = unit(1, "mm"), legend.key.height = unit(1, "mm"),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.box.background = element_rect(fill='transparent', colour = NA),
    text = element_text(family = "sans")
  ) +
  scale_fill_manual(values = color_coo)
g -> g.dense
plot(g.dense)
```

# boxplot of CD79B Hscore among DLBCL90_COO
```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE}
library(ggplot2);library(dplyr);library(rstatix);library(ggpubr)

# boxplot
xy <- reshape2::melt(df[,c("DLBCL90", "OKU_CD79b_Hscore")])
res.kruskal <- xy %>% kruskal_test(value ~ DLBCL90)
stat.test <-  xy  %>% dunn_test(value ~ DLBCL90) %>%
  adjust_pvalue(method = "BH") %>% add_significance()
print(stat.test)
stat.test <- stat.test %>% mutate(y.position = c(280,300,260))
bxp <- ggboxplot(
  xy, x = "DLBCL90", y = "value", fill = "DLBCL90",
  outlier.shape = T, ylim=c(0,320)
)

g <- bxp+ 
  stat_pvalue_manual(stat.test, hide.ns = T)+
  labs(subtitle = get_test_label(res.kruskal, detailed = TRUE),
       #caption = get_pwc_label(stat.test)
       )+
  ylab("CD79b")+
  xlab("COO")+
  labs(title = "ALL") +
  theme(
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.text.x = element_text(size = 4.2, face = "bold"),
    axis.title.y = element_text(size = 7, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    legend.position = "none",
    plot.title = element_text(size = 5, face = "bold", hjust = 0.5, vjust = -3),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.box.background = element_rect(fill='transparent', colour = NA),
    text = element_text(family = "sans")
  ) +
  scale_fill_manual(values = color_coo)
g -> g.box.coo.all
print(g.box.coo.all)
```

#pie chart of CD79B Hscore class among DLBCL90_COO
```{r message=FALSE, warning=FALSE}
library(ggplot2);library(dplyr)

df <- read.csv("./saved/Scores/OKU_defined_cohort_withoutUNC.csv")
res <- summary(df$OKU_CD79b_Hscore)

foo <- df %>%
    dplyr::group_by(OKU_CD79b_Hscore_class) %>%
    dplyr::select(DLBCL90) %>%
    table %>%
    as.data.frame() %>%
    dplyr::group_by(OKU_CD79b_Hscore_class) 

foo$OKU_CD79b_Hscore_class <- factor(foo$OKU_CD79b_Hscore_class, levels = c("High","Low"))
foo$DLBCL90 <- factor(foo$DLBCL90, levels = c("DZsig-pos","GCB","ABC"))

foo <- foo %>%
  dplyr::group_by(DLBCL90) %>%
  mutate(per=round(Freq/sum(Freq)*100))

g <- foo %>%
  ggplot(aes(x =  "", y = per, fill = OKU_CD79b_Hscore_class))+
  geom_bar(stat = "identity", width=1) + 
  coord_polar(theta = "y", start = 0)+
  ylab("")+
  xlab("DLBCL90")+
  facet_wrap(~DLBCL90) +
  #labs(title = "CD79b_Hscore_class among DLBCL90 COO (ALL)") +
  #geom_text(aes(label=paste0(per,"%")),position = position_stack(vjust=0.5))+
  theme(
    axis.title.x = element_text(size = 6, face = "bold"),
    axis.text.x = element_text(size = 5, face = "bold"),
    axis.title.y = element_text(size = 6, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    plot.title = element_text(size = 5, face = "bold"),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.text = element_text(size = 4.2, face = "bold"),
    legend.title = element_text(size = 5, face = "bold"),
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.position = "top",
    legend.key.size = unit(1,"mm"),
    legend.box.background = element_rect(fill='transparent', colour = NA)
  ) +
  scale_fill_manual(values = color_HighLow)
g -> g.pie.coo.all
print(g.pie.coo.all)
```

# boxplot of CD79B Hscore among Hans_COO
```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE}
library(ggplot2);library(dplyr)

df <- read.csv("./saved/Scores/OKU_defined_cohort_withoutUNC.csv")
res <- summary(df$OKU_CD79b_Hscore)
df$OKU_CD79b_Hscore_class <- factor(df$OKU_CD79b_Hscore_class, levels = c("Low","High"))

# boxplot
xy <- reshape2::melt(df[,c("Hans", "OKU_CD79b_Hscore")])
xy <- na.omit(xy)
stat.test <- xy %>% wilcox_test(value ~ Hans) %>% add_significance()
print(stat.test)
stat.test <- stat.test %>% mutate(y.position = 300)
bxp <- ggboxplot(
  xy, x = "Hans", y = "value", fill = "Hans",
  outlier.shape = T, ylim=c(0,320)
)

g <- bxp+ 
  stat_pvalue_manual(stat.test, hide.ns = T)+
  labs(subtitle = get_test_label(stat.test, detailed = TRUE),
       #caption = get_pwc_label(stat.test)
       )+
  ylab("CD79b")+
  xlab("COO(Hans)")+
  labs(title = "ALL") +
  theme(
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.text.x = element_text(size = 4.2, face = "bold"),
    axis.title.y = element_text(size = 7, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    legend.position = "none",
    plot.title = element_text(size = 5, face = "bold", hjust = 0.5, vjust = -3),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.box.background = element_rect(fill='transparent', colour = NA),
    text = element_text(family = "sans")
  ) +
  scale_fill_manual(values = color_hans)
g -> g.box.hans
print(g.box.hans)
```

#pie chart of CD79B Hscore class among Hans_COO
```{r message=FALSE, warning=FALSE}
library(ggplot2);library(dplyr)

df <- read.csv("./saved/Scores/OKU_defined_cohort_withoutUNC.csv")
res <- summary(df$OKU_CD79b_Hscore)

foo <- df %>%
    dplyr::group_by(OKU_CD79b_Hscore_class) %>%
    dplyr::select(Hans) %>%
    table %>%
    as.data.frame() %>%
    dplyr::group_by(OKU_CD79b_Hscore_class) 

foo$OKU_CD79b_Hscore_class <- factor(foo$OKU_CD79b_Hscore_class, levels = c("High","Low"))
foo$Hans <- factor(foo$Hans, levels = c("GCB","NonGC"))

foo <- foo %>%
  dplyr::group_by(Hans) %>%
  mutate(per=round(Freq/sum(Freq)*100))

g <- foo %>%
  ggplot(aes(x =  "", y = per, fill = OKU_CD79b_Hscore_class))+
  geom_bar(stat = "identity", width=1) + 
  coord_polar(theta = "y", start = 0)+
  ylab("")+
  xlab("Hans")+
  facet_wrap(~Hans) +
  #labs(title = "CD79b_Hscore_class among Hans COO (ALL)") +
  #geom_text(aes(label=paste0(per,"%")),position = position_stack(vjust=0.5))+
  theme(
    axis.title.x = element_text(size = 6, face = "bold"),
    axis.text.x = element_text(size = 5, face = "bold"),
    axis.title.y = element_text(size = 6, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    plot.title = element_text(size = 5, face = "bold"),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.text = element_text(size = 4.2, face = "bold"),
    legend.title = element_text(size = 5, face = "bold"),
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.position = "top",
    legend.key.size = unit(1,"mm"),
    legend.box.background = element_rect(fill='transparent', colour = NA)
  ) +
  scale_fill_manual(values = color_HighLow)
g -> g.pie.hans
print(g.pie.hans)
```

#patchwork
```{r fig.height=5, fig.width=12, message=FALSE, warning=FALSE}
library(patchwork)

g1 <- g.dense
g2 <- (g.box.coo.all/g.pie.coo.all) + plot_layout(heights = c(9,1))
g3 <- (g.box.hans/g.pie.hans) + plot_layout(heights = c(9,1))

g <- (g1|g2|g3) + plot_layout(widths = c(2.25,1.5,1.2))

plot(g)
ggsave("./saved/figs/OKU/Fig1.pdf", plot = g, width = 12, height = 5)
```

## clinical background ----
```{r message=FALSE, warning=FALSE}
library(gtsummary); library(flextable)

df <- read.csv("./saved/Scores/OKU_defined_cohort_withoutUNC.csv")

columnList <- c("DLBCL90", "AGE", "SEX", "IPIscore_class", 
                "ECOG_perfprmance_status_score", "Ann_Arbor_stage", "Lactate_dehydrogenase_level", 
                "BiopsySite", "No_of_extranodal_sites", "Treatment_regimen" ,"Primary_refractory", 
                "Early_refractory", "Central_nervous_system_relapse","OKU_CD79b_Pattern") 

tmp <- df[,c(columnList, "OKU_CD79b_Hscore_class")]

gt_tbl <- tmp %>%
  tbl_summary(by = "OKU_CD79b_Hscore_class",
              missing = "no",
              label = list(AGE ~ "Age, Median(range,years)",
                           SEX ~ "Sex (n, %)",
                           IPIscore_class ~ "IPI score (n, %)",
                           ECOG_perfprmance_status_score ~ "ECOG PS score (n, %)",
                           Ann_Arbor_stage ~ "Ann Arbor stage (n, %)",
                           Lactate_dehydrogenase_level ~ "Lactate dehydrogenase level (n, %)",
                           BiopsySite ~ "Biopsy Site (n, %)",
                           No_of_extranodal_sites ~ "No. of extranodal sites (n, %)",
                           Treatment_regimen ~ "Treatment_regimen (n, %)",
                           Primary_refractory ~ "Primary refractory (n, %)",
                           Early_refractory ~ "Early refractory (n, %)",
                           Central_nervous_system_relapse ~ "CNS relapse (n, %)",
                           DLBCL90 ~ "Cell-of-origin (n, %)",
                           OKU_CD79b_Pattern ~ "CD79B Staining Pattern (n, %)"
              ),
              type = list(c("SEX", "IPIscore_class", 
                            "ECOG_perfprmance_status_score", "Ann_Arbor_stage", "Lactate_dehydrogenase_level", 
                            "BiopsySite", "No_of_extranodal_sites", !"Treatment_regimen", 
                            "Primary_refractory", "Early_refractory", 
                            "Central_nervous_system_relapse", "DLBCL90", "OKU_CD79b_Pattern")~ "categorical",
                          c("AGE") ~ "continuous"),
              statistic = list(all_continuous() ~ "{median} ({min}-{max})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = all_continuous() ~ 1) %>%
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3),
        test = list(all_continuous()~"t.test",
                    all_categorical()~"chisq.test")) %>%
  bold_p(t = 0.05) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>%
  add_overall(col_label = "**ALL,** N = {N}") %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ 
                           "Comparison of baseline clinical and pathological characteristics according to CD79B H-score class in this study cohort")%>%
  as_flex_table() %>%
  save_as_docx(path = "./saved/figs/OKU/clinical_background_Entire-cohort(CD79B_Hscore_calss).docx")
```

#TME(CD3,CD4,CD8,CD68)
```{r fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
library(ggplot2);library(dplyr);library(ggpubr)

df <- read.csv("./saved/Scores/OKU_defined_cohort_withoutUNC.csv")
res <- summary(df$OKU_CD79b_Hscore)
df$OKU_CD79b_Hscore_class <- factor(df$OKU_CD79b_Hscore_class, levels = c("Low","High"))

# boxplot (CD3)
xy <- reshape2::melt(df[,c("OKU_CD79b_Hscore_class", "OKU_CD3_PosRate")])
xy <- na.omit(xy)
#xy$value <- xy$value*100
stat.test <- xy %>% wilcox_test(value ~ OKU_CD79b_Hscore_class) %>% add_significance()
print(stat.test)
stat.test <- stat.test %>% mutate(y.position = 0.8)
bxp <- ggboxplot(
  xy, x = "OKU_CD79b_Hscore_class", y = "value", color = "OKU_CD79b_Hscore_class",
  outlier.shape = T, ylim=c(0,1.1)
  #add = "boxplot", add.params = list(fill = "white")
  )

g <- bxp+ 
  stat_pvalue_manual(stat.test, hide.ns = T)+
  labs(subtitle = get_test_label(stat.test, detailed = TRUE),
       caption = get_pwc_label(stat.test))+
  ylab("CD3 Positive Cell Rate")+
  xlab("CD79B H-score class")+
  labs(title = "ALL") +
  theme(
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.text.x = element_text(size = 4.2, face = "bold"),
    axis.title.y = element_text(size = 7, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    legend.position = "none",
    plot.title = element_text(size = 5, face = "bold", hjust = 0.5, vjust = -3),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.box.background = element_rect(fill='transparent', colour = NA),
    text = element_text(family = "sans")
  ) +
  scale_fill_manual(values = rev(color_HighLow))+
  scale_color_manual(values = rev(color_HighLow))
g -> g.CD3

# boxplot (CD4)
xy <- reshape2::melt(df[,c("OKU_CD79b_Hscore_class", "OKU_CD4_PosRate")])
xy <- na.omit(xy)
#xy$value <- xy$value*100
stat.test <- xy %>% wilcox_test(value ~ OKU_CD79b_Hscore_class) %>% add_significance()
print(stat.test)
stat.test <- stat.test %>% mutate(y.position = 0.8)
bxp <- ggboxplot(
  xy, x = "OKU_CD79b_Hscore_class", y = "value", color = "OKU_CD79b_Hscore_class",
  outlier.shape = T, ylim=c(0,1.1)
  #add = "boxplot", add.params = list(fill = "white")
  )

g <- bxp+ 
  stat_pvalue_manual(stat.test, hide.ns = T)+
  labs(subtitle = get_test_label(stat.test, detailed = TRUE),
       caption = get_pwc_label(stat.test))+
  ylab("CD4 Positive Cell Rate")+
  xlab("CD79B H-score class")+
  labs(title = "ALL") +
  theme(
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.text.x = element_text(size = 4.2, face = "bold"),
    axis.title.y = element_text(size = 7, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    legend.position = "none",
    plot.title = element_text(size = 5, face = "bold", hjust = 0.5, vjust = -3),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.box.background = element_rect(fill='transparent', colour = NA),
    text = element_text(family = "sans")
  ) +
  scale_fill_manual(values = rev(color_HighLow))+
  scale_color_manual(values = rev(color_HighLow))
g -> g.CD4

# boxplot (CD8)
xy <- reshape2::melt(df[,c("OKU_CD79b_Hscore_class", "OKU_CD8_PosRate")])
xy <- na.omit(xy)
#xy$value <- xy$value*100
stat.test <- xy %>% wilcox_test(value ~ OKU_CD79b_Hscore_class) %>% add_significance()
print(stat.test)
stat.test <- stat.test %>% mutate(y.position = 0.8)
bxp <- ggboxplot(
  xy, x = "OKU_CD79b_Hscore_class", y = "value", color = "OKU_CD79b_Hscore_class",
  outlier.shape = T, ylim=c(0,1.1)
  #add = "boxplot", add.params = list(fill = "white")
  )

g <- bxp+ 
  stat_pvalue_manual(stat.test, hide.ns = T)+
  labs(subtitle = get_test_label(stat.test, detailed = TRUE),
       caption = get_pwc_label(stat.test))+
  ylab("CD8 Positive Cell Rate")+
  xlab("CD79B H-score class")+
  labs(title = "ALL") +
  theme(
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.text.x = element_text(size = 4.2, face = "bold"),
    axis.title.y = element_text(size = 7, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    legend.position = "none",
    plot.title = element_text(size = 5, face = "bold", hjust = 0.5, vjust = -3),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.box.background = element_rect(fill='transparent', colour = NA),
    text = element_text(family = "sans")
  ) +
  scale_fill_manual(values = rev(color_HighLow))+
  scale_color_manual(values = rev(color_HighLow))
g -> g.CD8

# boxplot (CD68)
xy <- reshape2::melt(df[,c("OKU_CD79b_Hscore_class", "OKU_CD68_PosRate")])
xy <- na.omit(xy)
#xy$value <- xy$value*100
stat.test <- xy %>% wilcox_test(value ~ OKU_CD79b_Hscore_class) %>% add_significance()
print(stat.test)
stat.test <- stat.test %>% mutate(y.position = 0.8)
bxp <- ggboxplot(
  xy, x = "OKU_CD79b_Hscore_class", y = "value", color = "OKU_CD79b_Hscore_class",
  outlier.shape = T, ylim=c(0,1.1)
  #add = "boxplot", add.params = list(fill = "white")
  )

g <- bxp+ 
  stat_pvalue_manual(stat.test, hide.ns = T)+
  labs(subtitle = get_test_label(stat.test, detailed = TRUE),
       caption = get_pwc_label(stat.test))+
  ylab("CD68 Positive Cell Rate")+
  xlab("CD79B H-score class")+
  labs(title = "ALL") +
  theme(
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.text.x = element_text(size = 4.2, face = "bold"),
    axis.title.y = element_text(size = 7, face = "bold"),
    axis.text.y = element_text(size = 5, face = "bold"),
    legend.position = "none",
    plot.title = element_text(size = 5, face = "bold", hjust = 0.5, vjust = -3),
    plot.subtitle = element_text(size = 6, face = "bold", hjust = 1),
    panel.background = element_rect(fill='transparent'), 
    plot.background = element_rect(fill='transparent', color=NA), 
    legend.background = element_rect(fill='transparent', colour = NA), 
    legend.box.background = element_rect(fill='transparent', colour = NA),
    text = element_text(family = "sans")
  ) +
  scale_fill_manual(values = rev(color_HighLow))+
  scale_color_manual(values = rev(color_HighLow))
g -> g.CD68

print((g.CD3|g.CD4)|(g.CD8|g.CD68))
ggsave("./saved/figs/OKU/TME_boxplot(CD79B_Hscore).pdf",
       plot = (g.CD3|g.CD4)|(g.CD8|g.CD68),
       width = 8, height = 8)
```

#Sessioninfo
```{r message=FALSE, warning=FALSE}
sessionInfo()
```



















